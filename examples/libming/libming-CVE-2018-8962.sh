#!/bin/bash

set -euo pipefail

#for aflgo
git clone https://github.com/libming/libming.git libming-CVE-2018-8962
cd libming-CVE-2018-8962/; git checkout b72cc2f # version 0.4.8
export LIBMING_SRC=$PWD
export BUILD_DIR=$LIBMING_SRC/build
mkdir $BUILD_DIR; mkdir -p symsan/targets
pushd symsan

# set ENV vars
export KO_CXX=clang++-12
export KO_CC=clang-12
export MAZERUNNER_SRC=/workdir/symsan
export CXX=$MAZERUNNER_SRC/build/bin/ko-clang++
export CC=$MAZERUNNER_SRC/build/bin/ko-clang
export KO_ADD_AFLGO=1
export KO_DONT_OPTIMIZE=1
export KO_USE_FASTGEN=1
export KO_NO_NATIVE_ZLIB=1
export LDFLAGS=-lpthread
export AFLGO_TARGET_DIR=$LIBMING_SRC/symsan/targets

# generate CFGs
export AFLGO_PREPROCESSING=1
echo $'decompile.c:398' > $AFLGO_TARGET_DIR/BBtargets.txt
../autogen.sh; CFLAGS="-fcommon" ../configure --disable-shared --prefix=`pwd`
make clean; make -j$(nproc)
pushd util; make clean && make swftophp; popd

# generate whole program bitcode
cd ..; mkdir obj-dist; pushd obj-dist
export ADDITIONAL="-flto -fuse-ld=gold -Wl,-plugin-opt=save-temps"
../autogen.sh; CFLAGS="-fcommon $ADDITIONAL" CXXFLAGS="$ADDITIONAL" ../configure --disable-shared --prefix=`pwd`
make clean; make -j$(nproc)
cp util/swftophp.0.0.preopt.bc $AFLGO_TARGET_DIR
cp util/swftophp $BUILD_DIR/swftophp_orig
popd

# compute distances
export SVF=/workdir/SVF
pushd $SVF; source ./setup.sh; popd
pushd $AFLGO_TARGET_DIR
wpa -print-fp -ander -dump-callgraph swftophp.0.0.preopt.bc &> indirect_call_analysis.log
python static_analysis.py $AFLGO_TARGET_DIR swftophp CVE-2018-8962
popd

# instrument distances
unset AFLGO_PREPROCESSING
export CXX=$MAZERUNNER_SRC/build/bin/ko-clang++
export CC=$MAZERUNNER_SRC/build/bin/ko-clang
../autogen.sh; CFLAGS="-fcommon" ../configure --disable-shared --prefix=`pwd`
make clean; make -j$(nproc)
cp util/swftophp $BUILD_DIR/swftophp_symsan_NM

# check if the binary is corrected built:
nm util/swftophp | grep __afl_auto_init
pushd $BUILD_DIR
rm -rf Output; mkdir Output
cp $MAZERUNNER_SRC/examples/libming/in $BUILD_DIR
TAINT_OPTIONS="taint_file=$BUILD_DIR/in/bumble-bee1.swf:output_dir=Output:debug=0" $MAZERUNNER_SRC/mazerunner/fgtest.py ./swftophp_symsan_NM $BUILD_DIR/in/bumble-bee1.swf
popd
