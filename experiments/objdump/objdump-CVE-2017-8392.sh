#!/bin/bash

set -euo pipefail

# checkout the source code
git clone git://sourceware.org/git/binutils-gdb.git binutils
cd binutils; git checkout a6c21d4a553de184562fd8409a5bcd3f2cc2561a
export MAZERUNNER_SRC=/workdir/symsan/mazerunner
export BINUTILS_SRC=$PWD
export EXP_DIR=$BINUTILS_SRC/CVE-2017-8392
mkdir $EXP_DIR; mkdir -p symsan/targets
cp -r $MAZERUNNER_SRC/experiments/objdump/in $BINUTILS_SRC
pushd symsan

# set ENV vars
export KO_CXX=clang++-12
export KO_CC=clang-12
export CXX=$MAZERUNNER_SRC/build/bin/ko-clang++
export CC=$MAZERUNNER_SRC/build/bin/ko-clang
export TMP_DIR=$PWD
export AFLGO_TARGET_DIR=$TMP_DIR/targets
export KO_ADD_AFLGO=1
export KO_DONT_OPTIMIZE=1
export KO_USE_FASTGEN=1
export KO_NO_NATIVE_ZLIB=1
export LDFLAGS=-lpthread
export AFLGO_PREPROCESSING=1

# generate CFGs
echo $'dwarf2.c:4212' > $TMP_DIR/BBtargets.txt
CFLAGS="-DFORTIFY_SOURCE=2 -fstack-protector-all -fno-omit-frame-pointer -g -Wno-error" LDFLAGS="-ldl -lutil" ../configure --disable-shared --disable-gdb --disable-libdecnumber --disable-readline --disable-sim --disable-ld
make clean; make -j$(nproc)
pushd binutils; make clean && make objdump; popd

# generate whole program bitcode
cd ..; mkdir build; cd build
export CC=clang-12
export CXX=clang++-12
CFLAGS="-DFORTIFY_SOURCE=2 -fstack-protector-all -fno-omit-frame-pointer -g -Wno-error -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps" LDFLAGS="-ldl -lutil" ../configure --disable-shared --disable-gdb --disable-libdecnumber --disable-readline --disable-sim --disable-ld
make clean; make -j$(nproc)
cp binutils/objdump.0.0.preopt.bc $AFLGO_TARGET_DIR
cp binutils/objdump $EXP_DIR/objdump_orig
popd

# compute distances
export SVF=/workdir/SVF
pushd $SVF; source ./setup.sh; popd
pushd $AFLGO_TARGET_DIR
wpa -print-fp -ander -dump-callgraph objdump.0.0.preopt.bc &> indirect_call_analysis.log
python static_analysis.py $AFLGO_TARGET_DIR objdump CVE-2017-8392
popd

# instrument distances
unset AFLGO_PREPROCESSING
export CXX=$MAZERUNNER_SRC/build/bin/ko-clang++
export CC=$MAZERUNNER_SRC/build/bin/ko-clang
CFLAGS="-DFORTIFY_SOURCE=2 -fstack-protector-all -fno-omit-frame-pointer -g -Wno-error" LDFLAGS="-ldl -lutil" ../configure --disable-shared --disable-gdb --disable-libdecnumber --disable-readline --disable-sim --disable-ld
make clean; make -j$(nproc)
cp binutils/objdump $EXP_DIR/objdump_symsan_NF

# check if the binary is corrected built:
nm binutils/objdump | grep __afl_auto_init
pushd $EXP_DIR
rm -rf Output; mkdir Output
BIN_ARGS="-SD" TAINT_OPTIONS="taint_file=$BINUTILS_SRC/in/test:output_dir=Output:debug=0" $MAZERUNNER_SRC/mazerunner/fgtest.py ./objdump_symsan_NF $BINUTILS_SRC/in/test
popd
